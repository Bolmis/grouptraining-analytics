<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Group Training Analytics | StrongSales</title>
  <!-- Prevent header flash in embed mode -->
  <script>
    (function() {
      var params = new URLSearchParams(window.location.search);
      if (params.get('hideHeader') === 'true') {
        document.documentElement.classList.add('embed-hide-header');
      }
    })();
  </script>
  <style>
    .embed-hide-header #header,
    .embed-hide-header #footer { display: none !important; }
  </style>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            strongsales: {
              50: '#f5f3ff',
              100: '#ede9fe',
              200: '#ddd6fe',
              300: '#AFACFB',
              400: '#a78bfa',
              500: '#8b5cf6',
              600: '#7c3aed',
              700: '#6d28d9',
              800: '#5b21b6',
              900: '#4c1d95',
            }
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #AFACFB 0%, #8b5cf6 50%, #6d28d9 100%);
    }

    .glass {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
    }

    .card-shadow {
      box-shadow: 0 4px 6px -1px rgba(175, 172, 251, 0.1), 0 2px 4px -2px rgba(175, 172, 251, 0.1);
    }

    .card-shadow-lg {
      box-shadow: 0 10px 15px -3px rgba(175, 172, 251, 0.15), 0 4px 6px -4px rgba(175, 172, 251, 0.1);
    }

    @keyframes pulse-soft {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .animate-pulse-soft {
      animation: pulse-soft 2s ease-in-out infinite;
    }

    /* Hide scrollbar for cleaner iframe look */
    .iframe-mode::-webkit-scrollbar {
      width: 6px;
    }
    .iframe-mode::-webkit-scrollbar-track {
      background: transparent;
    }
    .iframe-mode::-webkit-scrollbar-thumb {
      background: #AFACFB;
      border-radius: 3px;
    }

    /* Progress bar styles */
    .progress-excellent { background: linear-gradient(90deg, #10b981, #34d399); }
    .progress-good { background: linear-gradient(90deg, #22c55e, #4ade80); }
    .progress-average { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .progress-low { background: linear-gradient(90deg, #ef4444, #f87171); }

    /* Multi-select dropdown */
    .multiselect-dropdown {
      position: relative;
    }
    .multiselect-dropdown .dropdown-btn {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .multiselect-dropdown .dropdown-content {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
      z-index: 50;
      max-height: 300px;
      overflow-y: auto;
      display: none;
    }
    .multiselect-dropdown.open .dropdown-content {
      display: block;
    }
    .multiselect-dropdown .dropdown-item {
      padding: 10px 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.15s;
    }
    .multiselect-dropdown .dropdown-item:hover {
      background: #f9fafb;
    }
    .multiselect-dropdown .dropdown-item.selected {
      background: #f5f3ff;
    }
    .multiselect-dropdown .dropdown-item .checkbox {
      width: 18px;
      height: 18px;
      border: 2px solid #d1d5db;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .multiselect-dropdown .dropdown-item.selected .checkbox {
      background: #AFACFB;
      border-color: #AFACFB;
    }
    .multiselect-dropdown .color-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    /* Facility dropdown styles */
    .facility-filter .dropdown-item {
      padding: 10px 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.15s;
    }
    .facility-filter .dropdown-item:hover {
      background: #f9fafb;
    }
    .facility-filter .dropdown-item.selected {
      background: #f5f3ff;
      color: #6b5ce7;
      font-weight: 500;
    }

    /* Tooltip styles */
    .info-tooltip {
      position: relative;
      display: inline-flex;
      align-items: center;
      cursor: help;
      margin-left: 4px;
    }
    .info-tooltip .info-icon {
      width: 14px;
      height: 14px;
      color: #9ca3af;
      transition: color 0.15s;
    }
    .info-tooltip:hover .info-icon {
      color: #6b7280;
    }
    .info-tooltip .tooltip-text {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: #fff;
      font-size: 12px;
      font-weight: 400;
      padding: 8px 12px;
      border-radius: 8px;
      white-space: nowrap;
      z-index: 100;
      transition: opacity 0.15s, visibility 0.15s;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-width: 280px;
      white-space: normal;
      text-align: center;
      line-height: 1.4;
    }
    .info-tooltip .tooltip-text::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #1f2937;
    }
    .info-tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
    /* Table header tooltips - position to the right */
    th .info-tooltip .tooltip-text {
      left: 0;
      transform: translateX(0);
    }
    th .info-tooltip .tooltip-text::after {
      left: 12px;
      transform: translateX(0);
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Header - Hidden in iframe mode -->
  <header id="header" class="gradient-bg text-white shadow-lg">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex items-center justify-between">
        <!-- StrongSales Logo -->
        <div class="flex items-center space-x-4">
          <img src="/Strongsales%20logo%20WHITE.png" alt="StrongSales" class="h-10 w-auto">
          <div class="border-l border-white/30 pl-4">
            <p class="text-sm text-white/90 font-medium">Group Training Analytics</p>
          </div>
        </div>

        <!-- Right side: Powered by + Logout -->
        <div class="flex items-center gap-4">
          <div class="hidden sm:flex items-center space-x-2 text-sm text-white/60">
            <span>Powered by</span>
            <span class="font-semibold text-white/90">Zoezi</span>
          </div>
          <a href="/logout" id="logout-btn" class="hidden px-3 py-1.5 text-sm font-medium text-white/80 hover:text-white bg-white/10 hover:bg-white/20 rounded-lg transition-all">
            Logout
          </a>
        </div>
      </div>
    </div>
  </header>

  <!-- Controls Bar -->
  <div id="controls-bar" class="bg-white border-b border-gray-100 sticky top-0 z-40 card-shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex flex-wrap items-center gap-4">

        <!-- Embed Logo - Only shown when header is hidden -->
        <div id="embed-logo" class="hidden items-center self-center mr-4 pr-4 border-r border-gray-200">
          <img src="/Strongsales%20logo%20black%20%26%20purple%20Transparent.png" alt="StrongSales" class="h-7 w-auto">
        </div>

        <!-- Gym Selector - Hidden in iframe mode with clubId -->
        <div id="gym-selector-container" class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium text-gray-700 mb-1.5">Select Gym</label>
          <select id="gym-select" class="w-full px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 focus:ring-2 focus:ring-strongsales-300 focus:border-strongsales-300 transition-all">
            <option value="">Loading gyms...</option>
          </select>
        </div>

        <!-- Date Range -->
        <div class="flex items-end gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">From</label>
            <input type="date" id="from-date" class="px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 focus:ring-2 focus:ring-strongsales-300 focus:border-strongsales-300 transition-all">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">To</label>
            <input type="date" id="to-date" class="px-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-gray-900 focus:ring-2 focus:ring-strongsales-300 focus:border-strongsales-300 transition-all">
          </div>
        </div>

        <!-- Quick Presets -->
        <div class="flex items-end gap-2">
          <button onclick="setPreset('week')" class="px-4 py-2.5 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl transition-all">
            7 Days
          </button>
          <button onclick="setPreset('month')" class="px-4 py-2.5 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl transition-all">
            30 Days
          </button>
          <button onclick="setPreset('quarter')" class="px-4 py-2.5 text-sm font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-xl transition-all">
            90 Days
          </button>
        </div>

        <!-- Load Button -->
        <button id="load-btn" onclick="loadAnalytics()" class="px-6 py-2.5 bg-gradient-to-r from-strongsales-300 to-strongsales-500 hover:from-strongsales-400 hover:to-strongsales-600 text-white font-semibold rounded-xl shadow-lg shadow-strongsales-300/30 transition-all flex items-center gap-2">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          <span>Load Analytics</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div id="content">
      <!-- Empty State -->
      <div class="flex flex-col items-center justify-center py-20 text-center">
        <div class="w-20 h-20 bg-strongsales-100 rounded-2xl flex items-center justify-center mb-6">
          <svg class="w-10 h-10 text-strongsales-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M3 3v18h18"/>
            <path d="M18 17V9"/>
            <path d="M13 17V5"/>
            <path d="M8 17v-3"/>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Select a gym and date range</h2>
        <p class="text-gray-500 max-w-md">Choose a gym and time period to view attendance analytics and performance metrics.</p>
      </div>
    </div>
  </main>

  <!-- Footer - Minimal in iframe mode -->
  <footer id="footer" class="border-t border-gray-100 bg-white mt-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between text-sm text-gray-500">
        <span>StrongSales Analytics</span>
        <span>Powered by Zoezi</span>
      </div>
    </div>
  </footer>

  <script>
    // ==========================================================================
    // STATE & CONFIG
    // ==========================================================================
    let rawAnalytics = null;  // Original unfiltered data
    let analytics = null;     // Filtered data for display
    let charts = {};
    let selectedClassTypes = new Set();  // Selected class type names
    let allClassTypes = [];   // All available class types
    let selectedInstructor = null;  // Selected instructor name (null = all)
    let selectedFacility = null;  // Selected facility/site ID (null = all)
    let allFacilities = [];   // All available facilities/sites
    let isClassFilterOpen = false;  // Track dropdown open state
    let config = {
      isIframeMode: false,
      presetClubId: null,
      embedToken: null,       // Secure embed token
      hideHeader: false,
      hideGymSelector: false,
      isSecureEmbed: false    // Using token-based auth
    };

    // ==========================================================================
    // INITIALIZATION
    // ==========================================================================
    document.addEventListener('DOMContentLoaded', async () => {
      // Parse URL parameters
      const params = new URLSearchParams(window.location.search);
      config.embedToken = params.get('token');
      config.presetClubId = params.get('clubId');  // Legacy/insecure - kept for admin use
      config.hideHeader = params.get('hideHeader') === 'true';

      // Secure embed mode (token-based)
      if (config.embedToken) {
        config.isSecureEmbed = true;
        config.isIframeMode = true;
        config.hideGymSelector = true;

        // Verify token before proceeding
        const tokenValid = await verifyToken();
        if (!tokenValid) {
          showTokenError();
          return;
        }
      } else if (config.presetClubId) {
        // Legacy mode - only for admin/internal use
        config.isIframeMode = params.get('embed') === 'true' || true;
        config.hideGymSelector = true;
      }

      // Apply iframe mode styling
      if (config.isIframeMode) {
        document.body.classList.add('iframe-mode');
      }

      if (config.hideHeader) {
        document.getElementById('header').style.display = 'none';
        document.getElementById('footer').style.display = 'none';
        // Show embed logo in controls bar
        document.getElementById('embed-logo').classList.remove('hidden');
        document.getElementById('embed-logo').classList.add('flex');
      } else if (!config.isSecureEmbed) {
        // Show logout button for admin users (not embed mode)
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
          logoutBtn.classList.remove('hidden');
        }
      }

      if (config.hideGymSelector) {
        document.getElementById('gym-selector-container').style.display = 'none';
      }

      // Load gyms and set defaults
      if (!config.isSecureEmbed) {
        loadGyms();
      }
      setPreset('month');

      // Auto-load for secure embed
      if (config.isSecureEmbed) {
        setTimeout(() => loadAnalytics(), 300);
      }
    });

    // ==========================================================================
    // TOKEN VERIFICATION
    // ==========================================================================
    async function verifyToken() {
      try {
        const response = await fetch(`/api/verify-token?token=${encodeURIComponent(config.embedToken)}`);
        const result = await response.json();

        if (result.valid) {
          config.presetClubId = result.clubId;
          // Update title if club name available
          if (result.clubName) {
            document.title = `${result.clubName} Analytics | StrongSales`;
          }
          return true;
        }
        return false;
      } catch (error) {
        console.error('Token verification failed:', error);
        return false;
      }
    }

    function showTokenError() {
      document.getElementById('content').innerHTML = `
        <div class="flex flex-col items-center justify-center py-20 text-center">
          <div class="w-20 h-20 bg-red-100 rounded-2xl flex items-center justify-center mb-6">
            <svg class="w-10 h-10 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Access Denied</h2>
          <p class="text-gray-500 max-w-md">Invalid or expired embed token. Please contact your administrator for a valid dashboard link.</p>
        </div>
      `;
      // Hide controls bar for invalid tokens
      document.getElementById('controls-bar').style.display = 'none';
    }

    // ==========================================================================
    // API FUNCTIONS
    // ==========================================================================
    async function loadGyms() {
      // Skip loading gyms in secure embed mode
      if (config.isSecureEmbed) {
        return;
      }

      const select = document.getElementById('gym-select');
      try {
        const response = await fetch('/api/gyms');
        const gyms = await response.json();

        if (gyms.error) throw new Error(gyms.error);

        select.innerHTML = '<option value="">Select a gym...</option>' +
          gyms.map(g => `<option value="${g.Club_Zoezi_ID}">${g.Club_name}</option>`).join('');

        // If preset club ID (legacy/admin mode), select it and auto-load
        if (config.presetClubId && !config.isSecureEmbed) {
          select.value = config.presetClubId;
          // Auto-load after a short delay
          setTimeout(() => loadAnalytics(), 500);
        }
      } catch (error) {
        console.error('Error loading gyms:', error);
        select.innerHTML = '<option value="">Error loading gyms</option>';
      }
    }

    function setPreset(preset) {
      const today = new Date();
      const toDate = today.toISOString().split('T')[0];
      let fromDate;

      const tempDate = new Date();
      switch (preset) {
        case 'week':
          tempDate.setDate(tempDate.getDate() - 7);
          break;
        case 'month':
          tempDate.setDate(tempDate.getDate() - 30);
          break;
        case 'quarter':
          tempDate.setDate(tempDate.getDate() - 90);
          break;
      }
      fromDate = tempDate.toISOString().split('T')[0];

      document.getElementById('from-date').value = fromDate;
      document.getElementById('to-date').value = toDate;
    }

    async function loadAnalytics() {
      const clubId = config.presetClubId || document.getElementById('gym-select').value;
      const fromDate = document.getElementById('from-date').value;
      const toDate = document.getElementById('to-date').value;

      if (!clubId && !config.isSecureEmbed) {
        showError('Please select a gym');
        return;
      }

      if (!fromDate || !toDate) {
        showError('Please select a date range');
        return;
      }

      const btn = document.getElementById('load-btn');
      const content = document.getElementById('content');

      btn.disabled = true;
      btn.innerHTML = `
        <svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Loading...</span>
      `;

      content.innerHTML = `
        <div class="flex flex-col items-center justify-center py-20">
          <div class="w-16 h-16 border-4 border-strongsales-200 border-t-strongsales-500 rounded-full animate-spin mb-4"></div>
          <p class="text-gray-500 font-medium">Loading analytics data...</p>
        </div>
      `;

      try {
        let response;

        // Use secure embed endpoint if using token
        if (config.isSecureEmbed && config.embedToken) {
          response = await fetch(`/api/embed/analytics?token=${encodeURIComponent(config.embedToken)}&fromDate=${fromDate}&toDate=${toDate}`);
        } else {
          // Standard endpoint for admin view
          response = await fetch(`/api/analytics/${clubId}?fromDate=${fromDate}&toDate=${toDate}`);
        }

        rawAnalytics = await response.json();

        if (rawAnalytics.error) throw new Error(rawAnalytics.error);

        // Store previous filter state
        const previousClassTypes = new Set(selectedClassTypes);
        const previousInstructor = selectedInstructor;
        const previousFacility = selectedFacility;

        // Extract all class types for the filter
        const newClassTypes = rawAnalytics.byType.map(t => ({ name: t.name, color: t.color }));
        const newClassTypeNames = new Set(newClassTypes.map(t => t.name));

        // Extract facilities (only if more than 1)
        allFacilities = rawAnalytics.sites || [];

        // Preserve filters: keep selected types that still exist in new data
        if (previousClassTypes.size > 0 && allClassTypes.length > 0) {
          // Filter was previously set - preserve selections that still exist
          selectedClassTypes = new Set(
            [...previousClassTypes].filter(name => newClassTypeNames.has(name))
          );
          // If all previous selections are gone, select all new types
          if (selectedClassTypes.size === 0) {
            selectedClassTypes = new Set(newClassTypeNames);
          }
        } else {
          // First load or no previous filter - select all
          selectedClassTypes = new Set(newClassTypeNames);
        }

        allClassTypes = newClassTypes;

        // Preserve instructor filter if instructor still exists in new data
        if (previousInstructor) {
          const instructorExists = rawAnalytics.byInstructor?.some(i => i.name === previousInstructor);
          selectedInstructor = instructorExists ? previousInstructor : null;
        }

        // Preserve facility filter if facility still exists
        if (previousFacility) {
          const facilityExists = allFacilities.some(f => f.id === previousFacility);
          selectedFacility = facilityExists ? previousFacility : null;
        }

        // Apply filter and render
        applyFilters();
        renderDashboard();
      } catch (error) {
        console.error('Error loading analytics:', error);
        content.innerHTML = `
          <div class="flex flex-col items-center justify-center py-20 text-center">
            <div class="w-16 h-16 bg-red-100 rounded-2xl flex items-center justify-center mb-4">
              <svg class="w-8 h-8 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 8v4m0 4h.01"/>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-1">Error loading data</h3>
            <p class="text-gray-500">${error.message}</p>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.innerHTML = `
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
          </svg>
          <span>Load Analytics</span>
        `;
      }
    }

    function showError(message) {
      alert(message);
    }

    // ==========================================================================
    // CLASS TYPE & INSTRUCTOR FILTER
    // ==========================================================================
    function applyFilters() {
      if (!rawAnalytics || !rawAnalytics.rawWorkouts) return;

      // If no filters active, just use raw data
      if (selectedClassTypes.size === allClassTypes.length && !selectedInstructor && !selectedFacility) {
        analytics = { ...rawAnalytics };
        return;
      }

      // Filter raw workouts by selected class types, instructor, AND facility
      const filteredWorkouts = rawAnalytics.rawWorkouts.filter(w => {
        // Class type filter
        if (!selectedClassTypes.has(w.typeName)) return false;

        // Instructor filter
        if (selectedInstructor) {
          const hasInstructor = w.staffs && w.staffs.some(s => s.name === selectedInstructor);
          if (!hasInstructor) return false;
        }

        // Facility filter
        if (selectedFacility) {
          if (w.siteId !== selectedFacility) return false;
        }

        return true;
      });

      // Recalculate everything from filtered workouts
      const byType = {};
      const byDayOfWeek = { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] };
      const byHour = {};
      const byInstructor = {};
      const byDate = {};

      let totalClasses = 0;
      let totalBooked = 0;
      let totalCapacity = 0;
      let fullyBookedClasses = 0;
      let emptyClasses = 0;

      // Track unique users
      const allUniqueUsers = new Set();
      const uniqueUsersByType = {};

      filteredWorkouts.forEach(w => {
        const typeName = w.typeName;
        const space = w.space || 0;
        const booked = w.numBooked || 0;
        const startTime = new Date(w.startTime);
        const dayOfWeek = startTime.getDay();
        const hour = startTime.getHours();
        const dateStr = w.startTime.split(' ')[0];

        totalClasses++;
        totalBooked += booked;
        totalCapacity += space;

        if (space > 0 && booked >= space) fullyBookedClasses++;
        if (booked === 0) emptyClasses++;

        // By workout type
        if (!byType[typeName]) {
          byType[typeName] = {
            name: typeName,
            color: w.typeColor || '#667eea',
            classes: 0,
            totalBooked: 0,
            totalCapacity: 0,
            bookings: []
          };
          uniqueUsersByType[typeName] = new Set();
        }
        byType[typeName].classes++;
        byType[typeName].totalBooked += booked;
        byType[typeName].totalCapacity += space;
        byType[typeName].bookings.push(space > 0 ? (booked / space * 100) : 0);

        // Track unique users
        if (w.userIds && Array.isArray(w.userIds)) {
          w.userIds.forEach(userId => {
            allUniqueUsers.add(userId);
            uniqueUsersByType[typeName].add(userId);
          });
        }

        // By day of week
        byDayOfWeek[dayOfWeek].push({
          booked,
          capacity: space,
          rate: space > 0 ? (booked / space * 100) : 0
        });

        // By hour
        if (!byHour[hour]) {
          byHour[hour] = { classes: 0, totalBooked: 0, totalCapacity: 0 };
        }
        byHour[hour].classes++;
        byHour[hour].totalBooked += booked;
        byHour[hour].totalCapacity += space;

        // By instructor
        if (w.staffs && w.staffs.length > 0) {
          w.staffs.forEach(staff => {
            const name = staff.name || 'Unknown';
            if (!byInstructor[name]) {
              byInstructor[name] = {
                name,
                classes: 0,
                totalBooked: 0,
                totalCapacity: 0,
                imagekey: staff.imagekey
              };
            }
            byInstructor[name].classes++;
            byInstructor[name].totalBooked += booked;
            byInstructor[name].totalCapacity += space;
          });
        }

        // By date (for trend)
        if (!byDate[dateStr]) {
          byDate[dateStr] = { classes: 0, totalBooked: 0, totalCapacity: 0 };
        }
        byDate[dateStr].classes++;
        byDate[dateStr].totalBooked += booked;
        byDate[dateStr].totalCapacity += space;
      });

      // Calculate type stats
      const typeStats = Object.values(byType).map(t => ({
        ...t,
        avgAttendance: t.classes > 0 ? (t.totalBooked / t.classes).toFixed(1) : 0,
        attendanceRate: t.totalCapacity > 0 ? (t.totalBooked / t.totalCapacity * 100).toFixed(1) : 0,
        avgBookingRate: t.bookings.length > 0
          ? (t.bookings.reduce((a, b) => a + b, 0) / t.bookings.length).toFixed(1)
          : 0,
        uniqueParticipants: uniqueUsersByType[t.name]?.size || 0
      })).sort((a, b) => parseFloat(b.attendanceRate) - parseFloat(a.attendanceRate));

      // Calculate day stats
      const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const dayStats = dayNames.map((name, i) => {
        const data = byDayOfWeek[i];
        const dayTotalBooked = data.reduce((sum, d) => sum + d.booked, 0);
        const dayTotalCapacity = data.reduce((sum, d) => sum + d.capacity, 0);
        return {
          day: name,
          dayIndex: i,
          classes: data.length,
          avgAttendance: data.length > 0 ? (dayTotalBooked / data.length).toFixed(1) : 0,
          attendanceRate: dayTotalCapacity > 0 ? (dayTotalBooked / dayTotalCapacity * 100).toFixed(1) : 0
        };
      });

      // Calculate hour stats
      const hourStats = [];
      for (let h = 5; h <= 22; h++) {
        const data = byHour[h] || { classes: 0, totalBooked: 0, totalCapacity: 0 };
        hourStats.push({
          hour: h,
          label: `${h}:00`,
          classes: data.classes,
          avgAttendance: data.classes > 0 ? (data.totalBooked / data.classes).toFixed(1) : 0,
          attendanceRate: data.totalCapacity > 0 ? (data.totalBooked / data.totalCapacity * 100).toFixed(1) : 0
        });
      }

      // Calculate instructor stats
      const instructorStats = Object.values(byInstructor).map(i => ({
        ...i,
        avgAttendance: i.classes > 0 ? (i.totalBooked / i.classes).toFixed(1) : 0,
        attendanceRate: i.totalCapacity > 0 ? (i.totalBooked / i.totalCapacity * 100).toFixed(1) : 0
      })).sort((a, b) => parseFloat(b.attendanceRate) - parseFloat(a.attendanceRate));

      // Daily trend
      const dates = Object.keys(byDate).sort();
      const dailyTrend = dates.map(date => {
        const data = byDate[date];
        return {
          date,
          classes: data.classes,
          totalBooked: data.totalBooked,
          totalCapacity: data.totalCapacity,
          attendanceRate: data.totalCapacity > 0 ? (data.totalBooked / data.totalCapacity * 100).toFixed(1) : 0
        };
      });

      analytics = {
        ...rawAnalytics,
        summary: {
          totalClasses,
          totalBooked,
          totalCapacity,
          overallAttendanceRate: totalCapacity > 0 ? (totalBooked / totalCapacity * 100).toFixed(1) : 0,
          avgPerClass: totalClasses > 0 ? (totalBooked / totalClasses).toFixed(1) : 0,
          fullyBookedClasses,
          fullyBookedRate: totalClasses > 0 ? (fullyBookedClasses / totalClasses * 100).toFixed(1) : 0,
          emptyClasses,
          emptyRate: totalClasses > 0 ? (emptyClasses / totalClasses * 100).toFixed(1) : 0,
          uniqueParticipants: allUniqueUsers.size
        },
        byType: typeStats,
        byDay: dayStats,
        byHour: hourStats,
        byInstructor: instructorStats,
        dailyTrend
      };
    }

    function toggleClassType(typeName) {
      if (selectedClassTypes.has(typeName)) {
        selectedClassTypes.delete(typeName);
      } else {
        selectedClassTypes.add(typeName);
      }
      // Remember dropdown was open
      isClassFilterOpen = true;
      updateFilterDropdown();
      applyFilters();
      renderDashboard();
    }

    function selectAllClassTypes() {
      selectedClassTypes = new Set(allClassTypes.map(t => t.name));
      // Remember dropdown was open
      isClassFilterOpen = true;
      updateFilterDropdown();
      applyFilters();
      renderDashboard();
    }

    function clearAllClassTypes() {
      selectedClassTypes.clear();
      // Remember dropdown was open
      isClassFilterOpen = true;
      updateFilterDropdown();
      applyFilters();
      renderDashboard();
    }

    function selectInstructor(instructorName) {
      selectedInstructor = instructorName;
      applyFilters();
      renderDashboard();
    }

    function clearInstructorFilter() {
      selectedInstructor = null;
      applyFilters();
      renderDashboard();
    }

    function selectFacility(facilityId) {
      selectedFacility = facilityId;
      applyFilters();
      renderDashboard();
    }

    function clearFacilityFilter() {
      selectedFacility = null;
      applyFilters();
      renderDashboard();
    }

    function toggleFacilityDropdown(event) {
      event.stopPropagation();
      const dropdown = event.target.closest('.facility-filter');
      if (dropdown) {
        const menu = dropdown.querySelector('.dropdown-menu');
        if (menu) {
          const isOpen = menu.style.display !== 'none';
          menu.style.display = isOpen ? 'none' : 'block';
        }
      }
    }

    function closeFacilityDropdown() {
      document.querySelectorAll('.facility-filter .dropdown-menu').forEach(menu => {
        menu.style.display = 'none';
      });
    }

    // Close facility dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.facility-filter')) {
        closeFacilityDropdown();
      }
    });

    function toggleFilterDropdown() {
      const dropdown = document.getElementById('class-type-filter');
      if (dropdown) {
        dropdown.classList.toggle('open');
        isClassFilterOpen = dropdown.classList.contains('open');
        // Clear search and show all when opening
        if (isClassFilterOpen) {
          const searchInput = dropdown.querySelector('input[type="text"]');
          if (searchInput) {
            searchInput.value = '';
            filterClassDropdown('');
          }
        }
      }
    }

    function filterClassDropdown(searchTerm) {
      const dropdown = document.getElementById('class-type-filter');
      if (!dropdown) return;

      const items = dropdown.querySelectorAll('.dropdown-item[data-type]');
      const term = searchTerm.toLowerCase().trim();

      items.forEach(item => {
        const typeName = item.dataset.type.toLowerCase();
        if (term === '' || typeName.includes(term)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    function updateFilterDropdown() {
      const dropdown = document.getElementById('class-type-filter');
      if (!dropdown) return;

      const btnText = dropdown.querySelector('.btn-text');
      const itemsContainer = dropdown.querySelector('.dropdown-items');

      // Update button text
      if (selectedClassTypes.size === 0) {
        btnText.textContent = 'No classes selected';
      } else if (selectedClassTypes.size === allClassTypes.length) {
        btnText.textContent = 'All classes';
      } else {
        btnText.textContent = `${selectedClassTypes.size} of ${allClassTypes.length} classes`;
      }

      // Update checkboxes
      itemsContainer.querySelectorAll('.dropdown-item[data-type]').forEach(item => {
        const typeName = item.dataset.type;
        if (selectedClassTypes.has(typeName)) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('class-type-filter');
      if (dropdown && !dropdown.contains(e.target)) {
        dropdown.classList.remove('open');
        isClassFilterOpen = false;
      }
    });

    // ==========================================================================
    // RENDER DASHBOARD
    // ==========================================================================
    function renderDashboard() {
      const content = document.getElementById('content');

      // Handle no data case
      if (!analytics || selectedClassTypes.size === 0) {
        content.innerHTML = `
          <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <div>
              <h2 class="text-2xl font-bold text-gray-900">${rawAnalytics?.club?.name || 'Analytics'}</h2>
              <p class="text-gray-500">${rawAnalytics?.dateRange?.fromDate || ''} to ${rawAnalytics?.dateRange?.toDate || ''}</p>
            </div>
            <div class="flex items-center gap-3">
              <!-- Class Type Filter -->
              <div id="class-type-filter" class="multiselect-dropdown">
                <button type="button" onclick="toggleFilterDropdown()" class="dropdown-btn px-4 py-2 bg-white border border-gray-200 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-all card-shadow">
                  <svg class="w-4 h-4 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                  </svg>
                  <span class="btn-text">No classes selected</span>
                  <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 9l-7 7-7-7"/>
                  </svg>
                </button>
                <div class="dropdown-content" style="min-width: 280px;">
                  <div class="p-2 border-b border-gray-100">
                    <input type="text" placeholder="Search classes..." onclick="event.stopPropagation();" oninput="filterClassDropdown(this.value)" class="w-full px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-strongsales-300 focus:border-strongsales-300">
                  </div>
                  <div class="p-2 border-b border-gray-100 flex gap-2">
                    <button onclick="selectAllClassTypes(); event.stopPropagation();" class="flex-1 px-3 py-1.5 text-xs font-medium text-strongsales-600 bg-strongsales-50 hover:bg-strongsales-100 rounded-lg transition-all">
                      Select All
                    </button>
                    <button onclick="clearAllClassTypes(); event.stopPropagation();" class="flex-1 px-3 py-1.5 text-xs font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all">
                      Clear All
                    </button>
                  </div>
                  <div class="dropdown-items py-1" style="max-height: 250px; overflow-y: auto;">
                    ${allClassTypes.map(t => `
                      <div class="dropdown-item ${selectedClassTypes.has(t.name) ? 'selected' : ''}" data-type="${t.name}" onclick="toggleClassType('${t.name.replace(/'/g, "\\'")}'); event.stopPropagation();">
                        <div class="checkbox">
                          <svg class="w-3 h-3 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <path d="M5 13l4 4L19 7"/>
                          </svg>
                        </div>
                        <div class="color-dot" style="background: ${t.color || '#AFACFB'}"></div>
                        <span class="text-sm text-gray-700">${t.name}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>

              <!-- Facility Filter Dropdown (only if multiple facilities) -->
              ${allFacilities.length > 1 ? `
              <div class="relative facility-filter">
                <button onclick="toggleFacilityDropdown(event)" class="px-4 py-2 bg-white border border-gray-200 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-all flex items-center gap-2 card-shadow min-w-[140px]">
                  <svg class="w-4 h-4 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                  </svg>
                  <span class="truncate max-w-[120px]">${selectedFacility ? (allFacilities.find(f => f.id === selectedFacility)?.name || 'Facility') : 'All facilities'}</span>
                  <svg class="w-4 h-4 ml-auto transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </button>
                <div class="dropdown-menu absolute top-full left-0 mt-2 bg-white border border-gray-200 rounded-xl card-shadow-lg z-50 min-w-[200px]" style="display: none;">
                  <div class="py-1">
                    <div class="dropdown-item facility-item ${!selectedFacility ? 'selected' : ''}" onclick="selectFacility(null); closeFacilityDropdown();">
                      <span class="text-sm text-gray-700">All facilities</span>
                    </div>
                    ${allFacilities.map(f => `
                      <div class="dropdown-item facility-item ${selectedFacility === f.id ? 'selected' : ''}" onclick="selectFacility(${f.id}); closeFacilityDropdown();">
                        <span class="text-sm text-gray-700">${f.name}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
              ` : ''}
            </div>
          </div>
          <div class="flex flex-col items-center justify-center py-20 text-center">
            <div class="w-20 h-20 bg-gray-100 rounded-2xl flex items-center justify-center mb-6">
              <svg class="w-10 h-10 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
              </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">No classes selected</h2>
            <p class="text-gray-500 max-w-md mb-4">Select at least one class type from the filter to view analytics.</p>
            <button onclick="selectAllClassTypes()" class="px-6 py-2.5 bg-gradient-to-r from-strongsales-300 to-strongsales-500 text-white font-semibold rounded-xl shadow-lg">
              Show All Classes
            </button>
          </div>
        `;
        return;
      }

      const { summary, byType, byDay, byHour, byInstructor, dailyTrend, club, dateRange } = analytics;

      const filterBtnText = selectedClassTypes.size === allClassTypes.length
        ? 'All classes'
        : selectedClassTypes.size === 0
          ? 'No classes selected'
          : `${selectedClassTypes.size} of ${allClassTypes.length} classes`;

      content.innerHTML = `
        <!-- Club Info & Controls -->
        <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
          <div>
            <h2 class="text-2xl font-bold text-gray-900">${club.name}</h2>
            <p class="text-gray-500">${dateRange.fromDate} to ${dateRange.toDate}</p>
          </div>
          <div class="flex items-center gap-3">
            <!-- Class Type Filter -->
            <div id="class-type-filter" class="multiselect-dropdown">
              <button type="button" onclick="toggleFilterDropdown()" class="dropdown-btn px-4 py-2 bg-white border border-gray-200 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-all card-shadow">
                <svg class="w-4 h-4 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                </svg>
                <span class="btn-text">${filterBtnText}</span>
                <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M19 9l-7 7-7-7"/>
                </svg>
              </button>
              <div class="dropdown-content" style="min-width: 280px;">
                <div class="p-2 border-b border-gray-100">
                  <input type="text" placeholder="Search classes..." onclick="event.stopPropagation();" oninput="filterClassDropdown(this.value)" class="w-full px-3 py-2 text-sm bg-gray-50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-strongsales-300 focus:border-strongsales-300">
                </div>
                <div class="p-2 border-b border-gray-100 flex gap-2">
                  <button onclick="selectAllClassTypes(); event.stopPropagation();" class="flex-1 px-3 py-1.5 text-xs font-medium text-strongsales-600 bg-strongsales-50 hover:bg-strongsales-100 rounded-lg transition-all">
                    Select All
                  </button>
                  <button onclick="clearAllClassTypes(); event.stopPropagation();" class="flex-1 px-3 py-1.5 text-xs font-medium text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-lg transition-all">
                    Clear All
                  </button>
                </div>
                <div class="dropdown-items py-1" style="max-height: 250px; overflow-y: auto;">
                  ${allClassTypes.map(t => `
                    <div class="dropdown-item ${selectedClassTypes.has(t.name) ? 'selected' : ''}" data-type="${t.name}" onclick="toggleClassType('${t.name.replace(/'/g, "\\'")}'); event.stopPropagation();">
                      <div class="checkbox">
                        <svg class="w-3 h-3 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                          <path d="M5 13l4 4L19 7"/>
                        </svg>
                      </div>
                      <div class="color-dot" style="background: ${t.color || '#AFACFB'}"></div>
                      <span class="text-sm text-gray-700">${t.name}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>

            <!-- Facility Filter Dropdown (only if multiple facilities) -->
            ${allFacilities.length > 1 ? `
            <div class="relative facility-filter">
              <button onclick="toggleFacilityDropdown(event)" class="px-4 py-2 bg-white border border-gray-200 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-all flex items-center gap-2 card-shadow min-w-[140px]">
                <svg class="w-4 h-4 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                  <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                <span class="truncate max-w-[120px]">${selectedFacility ? (allFacilities.find(f => f.id === selectedFacility)?.name || 'Facility') : 'All facilities'}</span>
                <svg class="w-4 h-4 ml-auto transition-transform ${document.querySelector('.facility-filter .dropdown-menu.show') ? 'rotate-180' : ''}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"/>
                </svg>
              </button>
              <div class="dropdown-menu absolute top-full left-0 mt-2 bg-white border border-gray-200 rounded-xl card-shadow-lg z-50 min-w-[200px]" style="display: none;">
                <div class="py-1">
                  <div class="dropdown-item facility-item ${!selectedFacility ? 'selected' : ''}" onclick="selectFacility(null); closeFacilityDropdown();">
                    <span class="text-sm text-gray-700">All facilities</span>
                  </div>
                  ${allFacilities.map(f => `
                    <div class="dropdown-item facility-item ${selectedFacility === f.id ? 'selected' : ''}" onclick="selectFacility(${f.id}); closeFacilityDropdown();">
                      <span class="text-sm text-gray-700">${f.name}</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
            ` : ''}

            <!-- Export Button -->
            <button onclick="exportCSV()" class="px-4 py-2 bg-white border border-gray-200 rounded-xl text-gray-700 font-medium hover:bg-gray-50 transition-all flex items-center gap-2 card-shadow">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Export CSV
            </button>
          </div>
        </div>

        <!-- Filter Active Notice -->
        ${(selectedClassTypes.size < allClassTypes.length || selectedInstructor || selectedFacility) ? `
          <div class="mb-6 px-4 py-3 bg-strongsales-50 border border-strongsales-200 rounded-xl flex flex-wrap items-center gap-3">
            <svg class="w-5 h-5 text-strongsales-500 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
            </svg>
            <span class="text-sm text-strongsales-700">
              <strong>Filters active:</strong>
              ${selectedFacility ? `Facility: ${allFacilities.find(f => f.id === selectedFacility)?.name || selectedFacility}` : ''}
              ${selectedFacility && (selectedClassTypes.size < allClassTypes.length || selectedInstructor) ? '  ' : ''}
              ${selectedClassTypes.size < allClassTypes.length ? `${selectedClassTypes.size} of ${allClassTypes.length} class types` : ''}
              ${selectedClassTypes.size < allClassTypes.length && selectedInstructor ? '  ' : ''}
              ${selectedInstructor ? `Instructor: ${selectedInstructor}` : ''}
            </span>
            <button onclick="selectAllClassTypes(); clearInstructorFilter(); clearFacilityFilter();" class="ml-auto text-sm font-medium text-strongsales-600 hover:text-strongsales-800 flex-shrink-0">
              Clear all filters
            </button>
          </div>
        ` : ''}

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
          <!-- Main KPI -->
          <div class="col-span-2 md:col-span-1 gradient-bg rounded-2xl p-6 text-white card-shadow-lg">
            <p class="text-white/80 text-sm font-medium mb-1 flex items-center">
              Attendance Rate
              <span class="info-tooltip">
                <svg class="info-icon" style="color: rgba(255,255,255,0.6)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <path d="M12 16v-4m0-4h.01"/>
                </svg>
                <span class="tooltip-text">Percentage of available spots that were booked: (Total Bookings  Total Capacity)  100</span>
              </span>
            </p>
            <p class="text-4xl font-bold">${summary.overallAttendanceRate}%</p>
            <p class="text-white/60 text-sm mt-1">${summary.totalBooked} / ${summary.totalCapacity} spots</p>
          </div>

          <div class="bg-white rounded-2xl p-5 card-shadow">
            <p class="text-gray-500 text-sm font-medium mb-1">Total Classes</p>
            <p class="text-3xl font-bold text-gray-900">${summary.totalClasses}</p>
            <p class="text-gray-400 text-sm">${byType.length} types</p>
          </div>

          <div class="bg-white rounded-2xl p-5 card-shadow">
            <p class="text-gray-500 text-sm font-medium mb-1 flex items-center">
              Total Bookings
              ${tooltip('Total number of spots booked across all classes in the selected period')}
            </p>
            <p class="text-3xl font-bold text-gray-900">${summary.totalBooked}</p>
            <p class="text-gray-400 text-sm">${summary.avgPerClass} avg per class</p>
          </div>

          <div class="bg-white rounded-2xl p-5 card-shadow">
            <p class="text-gray-500 text-sm font-medium mb-1 flex items-center">
              Fully Booked
              ${tooltip('Classes where the number of bookings equals the class capacity (100% full)')}
            </p>
            <p class="text-3xl font-bold text-emerald-600">${summary.fullyBookedClasses}</p>
            <p class="text-gray-400 text-sm">${summary.fullyBookedRate}% of classes</p>
          </div>

          <div class="bg-white rounded-2xl p-5 card-shadow">
            <p class="text-gray-500 text-sm font-medium mb-1 flex items-center">
              Empty Classes
              ${tooltip('Classes with zero bookings')}
            </p>
            <p class="text-3xl font-bold text-red-500">${summary.emptyClasses}</p>
            <p class="text-gray-400 text-sm">${summary.emptyRate}% of classes</p>
          </div>

          ${summary.uniqueParticipants > 0 ? `
          <div class="bg-white rounded-2xl p-5 card-shadow">
            <p class="text-gray-500 text-sm font-medium mb-1 flex items-center">
              Unique Participants
              ${tooltip('Count of distinct members who made bookings. Lower unique vs total bookings indicates repeat attendance.')}
            </p>
            <p class="text-3xl font-bold text-indigo-600">${summary.uniqueParticipants}</p>
            <p class="text-gray-400 text-sm">${summary.totalBooked > 0 ? (summary.totalBooked / summary.uniqueParticipants).toFixed(1) : 0} bookings/person</p>
          </div>
          ` : ''}
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <!-- Trend Chart - Full Width -->
          <div class="lg:col-span-2 bg-white rounded-2xl p-6 card-shadow">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Attendance Trend</h3>
            <div class="h-80">
              <canvas id="trend-chart"></canvas>
            </div>
          </div>

          <!-- Class Type Performance -->
          <div class="bg-white rounded-2xl p-6 card-shadow">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">By Class Type</h3>
            <div class="h-72">
              <canvas id="type-chart"></canvas>
            </div>
          </div>

          <!-- Day of Week -->
          <div class="bg-white rounded-2xl p-6 card-shadow">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">By Day of Week</h3>
            <div class="h-72">
              <canvas id="day-chart"></canvas>
            </div>
          </div>

          <!-- Hourly -->
          <div class="bg-white rounded-2xl p-6 card-shadow">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">By Hour</h3>
            <div class="h-72">
              <canvas id="hour-chart"></canvas>
            </div>
          </div>

          <!-- Distribution -->
          <div class="bg-white rounded-2xl p-6 card-shadow">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              Class Distribution
              ${tooltip('How classes are distributed across types (by count of classes held)')}
            </h3>
            <div class="h-72">
              <canvas id="distribution-chart"></canvas>
            </div>
          </div>
        </div>

        <!-- Class Performance Table -->
        <div class="bg-white rounded-2xl p-6 card-shadow mb-8">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Class Performance Ranking</h3>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="text-left text-sm font-medium text-gray-500 border-b border-gray-100">
                  <th class="pb-3 pr-4">#</th>
                  <th class="pb-3 pr-4">Class Type</th>
                  <th class="pb-3 pr-4 text-center">Classes</th>
                  <th class="pb-3 pr-4 text-center">
                    <span class="inline-flex items-center">
                      Bookings
                      ${tooltip('Total bookings for this class type')}
                    </span>
                  </th>
                  <th class="pb-3 pr-4 text-center">
                    <span class="inline-flex items-center">
                      Unique
                      ${tooltip('Distinct members who booked. Lower unique vs bookings = more repeat attendance.')}
                    </span>
                  </th>
                  <th class="pb-3 pr-4 text-center">
                    <span class="inline-flex items-center">
                      Avg
                      ${tooltip('Average participants per class session')}
                    </span>
                  </th>
                  <th class="pb-3 pr-4 text-right">Rate</th>
                  <th class="pb-3 w-32">Performance</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-50">
                ${byType.map((t, i) => `
                  <tr class="hover:bg-gray-50 transition-colors">
                    <td class="py-3 pr-4 font-semibold text-gray-400">${i + 1}</td>
                    <td class="py-3 pr-4">
                      <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full" style="background: ${t.color}"></div>
                        <span class="font-medium text-gray-900">${t.name}</span>
                      </div>
                    </td>
                    <td class="py-3 pr-4 text-center text-gray-600">${t.classes}</td>
                    <td class="py-3 pr-4 text-center text-gray-600">${t.totalBooked}</td>
                    <td class="py-3 pr-4 text-center text-gray-600">${t.uniqueParticipants || '-'}</td>
                    <td class="py-3 pr-4 text-center text-gray-600">${t.avgAttendance}</td>
                    <td class="py-3 pr-4 text-right font-semibold text-gray-900">${t.attendanceRate}%</td>
                    <td class="py-3">
                      <div class="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full rounded-full ${getProgressClass(t.attendanceRate)}" style="width: ${Math.min(t.attendanceRate, 100)}%"></div>
                      </div>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Instructor Performance -->
        ${byInstructor.length > 0 ? `
          <div class="bg-white rounded-2xl p-6 card-shadow">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <h3 class="text-lg font-semibold text-gray-900">Instructor Performance</h3>
                ${selectedInstructor ? `
                  <span class="px-3 py-1 bg-strongsales-100 text-strongsales-700 text-sm font-medium rounded-full flex items-center gap-2">
                    ${selectedInstructor}
                    <button onclick="clearInstructorFilter()" class="hover:text-strongsales-900">
                      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                      </svg>
                    </button>
                  </span>
                ` : ''}
              </div>
              <span class="text-sm text-gray-500">${byInstructor.length} instructor${byInstructor.length !== 1 ? 's' : ''}</span>
            </div>
            ${selectedInstructor ? `
              <p class="text-sm text-gray-500 mb-4">Showing all data filtered by <strong>${selectedInstructor}</strong>. Click the X to see all instructors.</p>
            ` : `
              <p class="text-sm text-gray-500 mb-4">Click an instructor to filter all data by their classes.</p>
            `}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto pr-2" style="scrollbar-width: thin; scrollbar-color: #AFACFB #f3f4f6;">
              ${byInstructor.map((inst) => `
                <div onclick="selectInstructor('${inst.name.replace(/'/g, "\\'")}')" class="flex items-center gap-4 p-4 rounded-xl cursor-pointer transition-all ${selectedInstructor === inst.name ? 'bg-strongsales-100 ring-2 ring-strongsales-300' : 'bg-gray-50 hover:bg-gray-100'}">
                  <div class="w-12 h-12 gradient-bg rounded-full flex items-center justify-center text-white font-bold text-lg flex-shrink-0">
                    ${inst.name.charAt(0)}
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="font-semibold text-gray-900 truncate">${inst.name}</p>
                    <p class="text-sm text-gray-500">${inst.classes} classes  ${inst.totalBooked} bookings</p>
                  </div>
                  <div class="text-right flex-shrink-0">
                    <p class="text-xl font-bold text-gray-900">${inst.attendanceRate}%</p>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
      `;

      // Render charts
      renderCharts();

      // Restore dropdown open state after render
      if (isClassFilterOpen) {
        requestAnimationFrame(() => {
          const dropdown = document.getElementById('class-type-filter');
          if (dropdown) {
            dropdown.classList.add('open');
          }
        });
      }
    }

    function getProgressClass(rate) {
      if (rate >= 80) return 'progress-excellent';
      if (rate >= 60) return 'progress-good';
      if (rate >= 40) return 'progress-average';
      return 'progress-low';
    }

    // Tooltip helper
    function tooltip(text) {
      return `<span class="info-tooltip">
        <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M12 16v-4m0-4h.01"/>
        </svg>
        <span class="tooltip-text">${text}</span>
      </span>`;
    }

    // ==========================================================================
    // CHARTS
    // ==========================================================================
    function renderCharts() {
      // Destroy existing charts
      Object.values(charts).forEach(c => c?.destroy());

      const chartColors = {
        primary: '#AFACFB',
        primaryDark: '#8b5cf6',
        success: '#10b981',
        gray: '#e5e7eb'
      };

      // Trend Chart
      const trendCtx = document.getElementById('trend-chart').getContext('2d');
      charts.trend = new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: analytics.dailyTrend.map(d => d.date),
          datasets: [
            {
              label: 'Attendance Rate (%)',
              data: analytics.dailyTrend.map(d => d.attendanceRate),
              borderColor: chartColors.primary,
              backgroundColor: chartColors.primary + '20',
              fill: true,
              tension: 0.4,
              yAxisID: 'y'
            },
            {
              label: 'Total Bookings',
              data: analytics.dailyTrend.map(d => d.totalBooked),
              borderColor: chartColors.success,
              backgroundColor: 'transparent',
              borderDash: [5, 5],
              tension: 0.4,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { position: 'top' } },
          scales: {
            y: { type: 'linear', display: true, position: 'left', min: 0, title: { display: true, text: 'Rate (%)' } },
            y1: { type: 'linear', display: true, position: 'right', min: 0, title: { display: true, text: 'Bookings' }, grid: { drawOnChartArea: false } }
          }
        }
      });

      // Type Chart
      const typeCtx = document.getElementById('type-chart').getContext('2d');
      const top10 = analytics.byType.slice(0, 10);
      charts.type = new Chart(typeCtx, {
        type: 'bar',
        data: {
          labels: top10.map(t => t.name),
          datasets: [{
            label: 'Attendance Rate (%)',
            data: top10.map(t => t.attendanceRate),
            backgroundColor: top10.map(t => t.color || chartColors.primary),
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: { legend: { display: false } },
          scales: { x: { min: 0 } }
        }
      });

      // Day Chart
      const dayCtx = document.getElementById('day-chart').getContext('2d');
      const reorderedDays = [...analytics.byDay.slice(1), analytics.byDay[0]];
      charts.day = new Chart(dayCtx, {
        type: 'bar',
        data: {
          labels: reorderedDays.map(d => d.day.slice(0, 3)),
          datasets: [{
            label: 'Attendance Rate (%)',
            data: reorderedDays.map(d => d.attendanceRate),
            backgroundColor: reorderedDays.map(d => parseFloat(d.attendanceRate) >= 60 ? chartColors.success : parseFloat(d.attendanceRate) >= 40 ? '#f59e0b' : '#ef4444'),
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { min: 0 } }
        }
      });

      // Hour Chart
      const hourCtx = document.getElementById('hour-chart').getContext('2d');
      charts.hour = new Chart(hourCtx, {
        type: 'line',
        data: {
          labels: analytics.byHour.map(h => h.label),
          datasets: [{
            label: 'Attendance Rate (%)',
            data: analytics.byHour.map(h => h.attendanceRate),
            borderColor: chartColors.primary,
            backgroundColor: chartColors.primary + '20',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { y: { min: 0 } }
        }
      });

      // Distribution Chart
      const distCtx = document.getElementById('distribution-chart').getContext('2d');
      const top8 = analytics.byType.slice(0, 8);
      charts.distribution = new Chart(distCtx, {
        type: 'doughnut',
        data: {
          labels: top8.map(t => t.name),
          datasets: [{ data: top8.map(t => t.classes), backgroundColor: top8.map(t => t.color || chartColors.primary) }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'right' } }
        }
      });
    }

    // ==========================================================================
    // EXPORT
    // ==========================================================================
    function exportCSV() {
      if (!analytics) return;

      const { byType, summary, club, dateRange } = analytics;

      let csv = `Group Training Analytics Report\n`;
      csv += `Gym,${club.name}\n`;
      csv += `Period,${dateRange.fromDate} to ${dateRange.toDate}\n\n`;
      csv += `Summary\n`;
      csv += `Total Classes,${summary.totalClasses}\n`;
      csv += `Total Bookings,${summary.totalBooked}\n`;
      csv += `Total Capacity,${summary.totalCapacity}\n`;
      csv += `Overall Attendance Rate,${summary.overallAttendanceRate}%\n`;
      csv += `Avg per Class,${summary.avgPerClass}\n\n`;
      csv += `Class Performance\n`;
      csv += `Class Type,Classes,Total Bookings,Avg per Class,Attendance Rate\n`;
      byType.forEach(t => {
        csv += `"${t.name}",${t.classes},${t.totalBooked},${t.avgAttendance},${t.attendanceRate}%\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `analytics-${club.name}-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
